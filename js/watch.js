  /*
  000   000   0000000   000000000   0000000  000   000
  000 0 000  000   000     000     000       000   000
  000000000  000000000     000     000       000000000
  000   000  000   000     000     000       000   000
  00     00  000   000     000      0000000  000   000
  */
var Watch, _, event, fs, log, slash, walkdir,
  boundMethodCheck = function(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new Error('Bound instance method accessed before binding'); } };

({slash, log, fs, _} = require('./kxk'));

event = require('events');

walkdir = require('walkdir');

Watch = class Watch extends event {
  constructor(path, opt) {
    super();
    this.onChange = this.onChange.bind(this);
    this.dir = slash.resolve(path);
    this.opt = opt != null ? opt : {};
    this.watchDir();
  }

  static watch(path, opt) {
    if (slash.isDir(path)) {
      return Watch.dir(path, opt);
    } else {
      return Watch.file(path, opt);
    }
  }

  static file(path, opt) {
    var w;
    w = Watch.dir(slash.dir(path), opt);
    w.file = slash.resolve(path);
    return w;
  }

  static dir(path, opt) {
    return new Watch(path, opt);
  }

  close() {
    var i, len, ref, watch;
    this.watch.close();
    delete this.watch;
    if (this.opt.recursive) {
      ref = this.watchers;
      for (i = 0, len = ref.length; i < len; i++) {
        watch = ref[i];
        watch.close();
      }
      return delete this.watchers;
    }
  }

  watchDir() {
    var onPath;
    this.watch = fs.watch(this.dir);
    this.watch.on('error', function(err) {
      return log(`fs.watch dir:'${this.dir}' error: ${err.stack}`);
    });
    this.watch.on('change', this.onChange);
    if (this.opt.recursive) {
      // log 'ignore', @opt.ignore
      this.watchers = [];
      this.walker = walkdir(this.dir);
      onPath = function(ignore) {
        return function(path) {
          var i, len, regex;
          for (i = 0, len = ignore.length; i < len; i++) {
            regex = ignore[i];
            if (new RegExp(regex).test(path)) {
              // log "ignore #{regex} #{path}"
              this.ignore(path);
              return;
            }
          }
        };
      };
      if (this.opt.ignore) {
        this.walker.on('path', onPath(this.opt.ignore));
      }
      return this.walker.on('directory', (path) => {
        var change, watch;
        if (this.ignore(path)) {
          return;
        }
        log(`watch ${path}`);
        watch = fs.watch(path);
        this.watchers.push(watch);
        change = (dir) => {
          return (chg, pth) => {
            return this.onChange(chg, pth, dir);
          };
        };
        return watch.on('change', change(path));
      });
    }
  }

  ignore(path) {
    var i, len, ref, regex;
    if (this.opt.ignore) {
      ref = this.opt.ignore;
      for (i = 0, len = ref.length; i < len; i++) {
        regex = ref[i];
        if (new RegExp(regex).test(path)) {
          // log "ignore! #{regex} #{path}"
          return true;
        }
      }
    }
  }

  onChange(change, path, dir = this.dir) {
    boundMethodCheck(this, Watch);
    if (this.ignore(path)) {
      return;
    }
    log('onChange', change, path, dir);
    if (/\d\d\d\d\d\d\d\d?\d?$/.test(slash.ext(path))) {
      return;
    }
    path = slash.join(dir, path);
    log('onChange---', path);
    if (this.file && this.file !== path) {
      return;
    }
    return this.emit('change', {
      dir: dir,
      path: path,
      change: change,
      watch: this
    });
  }

};

module.exports = Watch;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2guanMiLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiLi4vY29mZmVlL3dhdGNoLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUFBLElBQUEsS0FBQSxFQUFBLENBQUEsRUFBQSxLQUFBLEVBQUEsRUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsT0FBQTtFQUFBOztBQVFBLENBQUEsQ0FBRSxLQUFGLEVBQVMsR0FBVCxFQUFjLEVBQWQsRUFBa0IsQ0FBbEIsQ0FBQSxHQUF3QixPQUFBLENBQVEsT0FBUixDQUF4Qjs7QUFFQSxLQUFBLEdBQVUsT0FBQSxDQUFRLFFBQVI7O0FBQ1YsT0FBQSxHQUFVLE9BQUEsQ0FBUSxTQUFSOztBQUVKLFFBQU4sTUFBQSxNQUFBLFFBQW9CLE1BQXBCO0VBRUksV0FBYSxDQUFDLElBQUQsRUFBTyxHQUFQLENBQUE7O1FBd0ViLENBQUEsZUFBQSxDQUFBO0lBcEVJLElBQUMsQ0FBQSxHQUFELEdBQU8sS0FBSyxDQUFDLE9BQU4sQ0FBYyxJQUFkO0lBQ1AsSUFBQyxDQUFBLEdBQUQsaUJBQU8sTUFBTSxDQUFBO0lBRWIsSUFBQyxDQUFBLFFBQUQsQ0FBQTtFQVBTOztFQVNMLE9BQVAsS0FBTyxDQUFDLElBQUQsRUFBTyxHQUFQLENBQUE7SUFFSixJQUFHLEtBQUssQ0FBQyxLQUFOLENBQVksSUFBWixDQUFIO2FBQ0ksS0FBSyxDQUFDLEdBQU4sQ0FBVSxJQUFWLEVBQWdCLEdBQWhCLEVBREo7S0FBQSxNQUFBO2FBR0ksS0FBSyxDQUFDLElBQU4sQ0FBVyxJQUFYLEVBQWlCLEdBQWpCLEVBSEo7O0VBRkk7O0VBT0QsT0FBTixJQUFNLENBQUMsSUFBRCxFQUFPLEdBQVAsQ0FBQTtBQUVILFFBQUE7SUFBQSxDQUFBLEdBQUksS0FBSyxDQUFDLEdBQU4sQ0FBVSxLQUFLLENBQUMsR0FBTixDQUFVLElBQVYsQ0FBVixFQUEyQixHQUEzQjtJQUNKLENBQUMsQ0FBQyxJQUFGLEdBQVMsS0FB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QWxCLENBQXVCLElBQXZCLENBQUg7O0FBRUksaUJBQU8sS0FGWDs7TUFESixDQURKOztFQUZJOztFQVFSLFFBQVUsQ0FBQyxNQUFELEVBQVMsSUFBVCxFQUFlLE1BQUksSUFBQyxDQUFBLEdBQXBCLENBQUE7MkJBMUVSO0lBNEVFLElBQVUsSUFBQyxDQUFBLE1BQUQsQ0FBUSxJQUFSLENBQVY7QUFBQSxhQUFBOztJQUVBLEdBQUEsQ0FBSSxVQUFKLEVBQWdCLE1BQWhCLEVBQXdCLElBQXhCLEVBQThCLEdBQTlCO0lBQ0EsSUFBRyx1QkFBdUIsQ0FBQyxJQUF4QixDQUE2QixLQUFLLENBQUMsR0FBTixDQUFVLElBQVYsQ0FBN0IsQ0FBSDtBQUNJLGFBREo7O0lBR0EsSUFBQSxHQUFPLEtBQUssQ0FBQyxJQUFOLENBQVcsR0FBWCxFQUFnQixJQUFoQjtJQUNQLEdBQUEsQ0FBSSxhQUFKLEVBQW1CLElBQW5CO0lBQ0EsSUFBRyxJQUFDLENBQUEsSUFBRCxJQUFVLElBQUMsQ0FBQSxJQUFELEtBQVMsSUFBdEI7QUFDSSxhQURKOztXQUdBLElBQUMsQ0FBQSxJQUFELENBQU0sUUFBTixFQUFnQjtNQUFBLEdBQUEsRUFBSSxHQUFKO01BQVMsSUFBQSxFQUFLLElBQWQ7TUFBb0IsTUFBQSxFQUFPLE1BQTNCO01BQW1DLEtBQUEsRUFBTTtJQUF6QyxDQUFoQjtFQWJNOztBQTFFZDs7QUF5RkEsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbjAwMCAgIDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMDAgICAwMDAwMDAwICAwMDAgICAwMDBcbjAwMCAwIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgICAgICAwMDAgICAwMDBcbjAwMDAwMDAwMCAgMDAwMDAwMDAwICAgICAwMDAgICAgIDAwMCAgICAgICAwMDAwMDAwMDBcbjAwMCAgIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgICAgICAwMDAgICAwMDBcbjAwICAgICAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgICAwMDAwMDAwICAwMDAgICAwMDBcbiMjI1xuXG57IHNsYXNoLCBsb2csIGZzLCBfIH0gPSByZXF1aXJlICcuL2t4aydcblxuZXZlbnQgICA9IHJlcXVpcmUgJ2V2ZW50cydcbndhbGtkaXIgPSByZXF1aXJlICd3YWxrZGlyJ1xuXG5jbGFzcyBXYXRjaCBleHRlbmRzIGV2ZW50XG5cbiAgICBjb25zdHJ1Y3RvcjogKHBhdGgsIG9wdCkgLT5cbiAgICAgICAgXG4gICAgICAgIHN1cGVyKClcbiAgICAgICAgXG4gICAgICAgIEBkaXIgPSBzbGFzaC5yZXNvbHZlIHBhdGhcbiAgICAgICAgQG9wdCA9IG9wdCA/IHt9XG4gICAgICAgIFxuICAgICAgICBAd2F0Y2hEaXIoKVxuICAgICAgIFxuICAgIEB3YXRjaDogKHBhdGgsIG9wdCkgLT5cbiAgICBcbiAgICAgICAgaWYgc2xhc2guaXNEaXIgcGF0aFxuICAgICAgICAgICAgV2F0Y2guZGlyIHBhdGgsIG9wdFxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBXYXRjaC5maWxlIHBhdGgsIG9wdFxuICAgIFxuICAgIEBmaWxlOiAocGF0aCwgb3B0KSAtPlxuICAgICAgICAgICAgXG4gICAgICAgIHcgPSBXYXRjaC5kaXIgc2xhc2guZGlyKHBhdGgpLCBvcHRcbiAgICAgICAgdy5maWxlID0gc2xhc2gucmVzb2x2ZSBwYXRoXG4gICAgICAgIHdcbiAgICAgICAgXG4gICAgQGRpcjogKHBhdGgsIG9wdCkgLT5cbiAgICAgICAgXG4gICAgICAgIG5ldyBXYXRjaCBwYXRoLCBvcHRcblxuICAgIGNsb3NlOiAtPlxuICAgICAgICBcbiAgICAgICAgQHdhdGNoLmNsb3NlKClcbiAgICAgICAgZGVsZXRlIEB3YXRjaFxuICAgICAgICBcbiAgICAgICAgaWYgQG9wdC5yZWN1cnNpdmVcbiAgICAgICAgICAgIGZvciB3YXRjaCBpbiBAd2F0Y2hlcnMgXG4gICAgICAgICAgICAgICAgd2F0Y2guY2xvc2UoKVxuICAgICAgICAgICAgZGVsZXRlIEB3YXRjaGVyc1xuICAgICAgICBcbiAgICB3YXRjaERpcjogLT5cbiAgICAgICAgXG4gICAgICAgIEB3YXRjaCA9IGZzLndhdGNoIEBkaXJcbiAgICAgICAgQHdhdGNoLm9uICdlcnJvcicsIChlcnIpIC0+IGxvZyBcImZzLndhdGNoIGRpcjonI3tAZGlyfScgZXJyb3I6ICN7ZXJyLnN0YWNrfVwiXG4gICAgICAgIEB3YXRjaC5vbiAnY2hhbmdlJywgQG9uQ2hhbmdlXG4gICAgICAgIFxuICAgICAgICBpZiBAb3B0LnJlY3Vyc2l2ZVxuICAgICAgICAgICAgIyBsb2cgJ2lnbm9yZScsIEBvcHQuaWdub3JlXG4gICAgICAgICAgICBAd2F0Y2hlcnMgPSBbXVxuICAgICAgICAgICAgQHdhbGtlciA9IHdhbGtkaXIgQGRpclxuICAgICAgICAgICAgb25QYXRoID0gKGlnbm9yZSkgLT4gKHBhdGgpIC0+IFxuICAgICAgICAgICAgICAgIGZvciByZWdleCBpbiBpZ25vcmVcbiAgICAgICAgICAgICAgICAgICAgaWYgbmV3IFJlZ0V4cChyZWdleCkudGVzdCBwYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICAjIGxvZyBcImlnbm9yZSAje3JlZ2V4fSAje3BhdGh9XCJcbiAgICAgICAgICAgICAgICAgICAgICAgIEBpZ25vcmUgcGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIEBvcHQuaWdub3JlXG4gICAgICAgICAgICAgICAgQHdhbGtlci5vbiAncGF0aCcsIG9uUGF0aCBAb3B0Lmlnbm9yZVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgQHdhbGtlci5vbiAnZGlyZWN0b3J5JywgKHBhdGgpID0+XG4gICAgICAgICAgICAgICAgcmV0dXJuIGlmIEBpZ25vcmUgcGF0aFxuICAgICAgICAgICAgICAgIGxvZyBcIndhdGNoICN7cGF0aH1cIlxuICAgICAgICAgICAgICAgIHdhdGNoID0gZnMud2F0Y2ggcGF0aFxuICAgICAgICAgICAgICAgIEB3YXRjaGVycy5wdXNoIHdhdGNoXG4gICAgICAgICAgICAgICAgY2hhbmdlID0gKGRpcikgPT4gKGNoZywgcHRoKSA9PiBAb25DaGFuZ2UgY2hnLCBwdGgsIGRpclxuICAgICAgICAgICAgICAgIHdhdGNoLm9uICdjaGFuZ2UnLCBjaGFuZ2UgcGF0aFxuXG4gICAgaWdub3JlOiAocGF0aCkgLT5cbiAgICAgICAgXG4gICAgICAgIGlmIEBvcHQuaWdub3JlXG4gICAgICAgICAgICBmb3IgcmVnZXggaW4gQG9wdC5pZ25vcmVcbiAgICAgICAgICAgICAgICBpZiBuZXcgUmVnRXhwKHJlZ2V4KS50ZXN0IHBhdGhcbiAgICAgICAgICAgICAgICAgICAgIyBsb2cgXCJpZ25vcmUhICN7cmVnZXh9ICN7cGF0aH1cIlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgICAgICAgICAgIFxuICAgIG9uQ2hhbmdlOiAoY2hhbmdlLCBwYXRoLCBkaXI9QGRpcikgPT5cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBpZiBAaWdub3JlIHBhdGhcbiAgICAgICAgXG4gICAgICAgIGxvZyAnb25DaGFuZ2UnLCBjaGFuZ2UsIHBhdGgsIGRpclxuICAgICAgICBpZiAvXFxkXFxkXFxkXFxkXFxkXFxkXFxkXFxkP1xcZD8kLy50ZXN0IHNsYXNoLmV4dCBwYXRoXG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgICBwYXRoID0gc2xhc2guam9pbiBkaXIsIHBhdGhcbiAgICAgICAgbG9nICdvbkNoYW5nZS0tLScsIHBhdGhcbiAgICAgICAgaWYgQGZpbGUgYW5kIEBmaWxlICE9IHBhdGhcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICAgICAgXG4gICAgICAgIEBlbWl0ICdjaGFuZ2UnLCBkaXI6ZGlyLCBwYXRoOnBhdGgsIGNoYW5nZTpjaGFuZ2UsIHdhdGNoOkBcbiAgICAgICAgXG5tb2R1bGUuZXhwb3J0cyA9IFdhdGNoXG4iXX0=
//# sourceURL=../coffee/watch.coffee