  /*
  000   000   0000000   000000000   0000000  000   000
  000 0 000  000   000     000     000       000   000
  000000000  000000000     000     000       000000000
  000   000  000   000     000     000       000   000
  00     00  000   000     000      0000000  000   000
  */
var Watch, _, event, fs, log, slash, walkdir,
  boundMethodCheck = function(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new Error('Bound instance method accessed before binding'); } };

({slash, log, fs, _} = require('./kxk'));

event = require('events');

walkdir = require('walkdir');

Watch = class Watch extends event {
  constructor(path, opt) {
    super();
    this.onChange = this.onChange.bind(this);
    this.dir = slash.resolve(path);
    this.opt = opt != null ? opt : {};
    this.watchDir();
  }

  static watch(path, opt) {
    if (slash.isDir(path)) {
      return Watch.dir(path, opt);
    } else {
      return Watch.file(path, opt);
    }
  }

  static file(path, opt) {
    var w;
    w = Watch.dir(slash.dir(path), opt);
    w.file = slash.resolve(path);
    return w;
  }

  static dir(path, opt) {
    return new Watch(path, opt);
  }

  close() {
    var i, len, ref, watch;
    this.watch.close();
    delete this.watch;
    if (this.opt.recursive) {
      ref = this.watchers;
      for (i = 0, len = ref.length; i < len; i++) {
        watch = ref[i];
        watch.close();
      }
      return delete this.watchers;
    }
  }

  watchDir() {
    var onPath;
    this.watch = fs.watch(this.dir);
    this.watch.on('error', function(err) {
      return log(`fs.watch dir:'${this.dir}' error: ${err.stack}`);
    });
    this.watch.on('change', this.onChange);
    if (this.opt.recursive) {
      // log 'ignore', @opt.ignore
      this.watchers = [];
      this.walker = walkdir(this.dir);
      onPath = function(ignore) {
        return function(path) {
          var i, len, regex;
          for (i = 0, len = ignore.length; i < len; i++) {
            regex = ignore[i];
            if (new RegExp(regex).test(path)) {
              // log "ignore #{regex} #{path}"
              this.ignore(path);
              return;
            }
          }
        };
      };
      if (this.opt.ignore) {
        this.walker.on('path', onPath(this.opt.ignore));
      }
      return this.walker.on('directory', (path) => {
        var change, watch;
        if (this.ignore(path)) {
          return;
        }
        // log "watch #{path}"
        watch = fs.watch(path);
        this.watchers.push(watch);
        change = (dir) => {
          return (chg, pth) => {
            return this.onChange(chg, pth, dir);
          };
        };
        return watch.on('change', change(path));
      });
    }
  }

  ignore(path) {
    var i, len, ref, regex;
    if (this.opt.ignore) {
      ref = this.opt.ignore;
      for (i = 0, len = ref.length; i < len; i++) {
        regex = ref[i];
        if (new RegExp(regex).test(path)) {
          // log "ignore! #{regex} #{path}"
          return true;
        }
      }
    }
  }

  onChange(change, path, dir = this.dir) {
    boundMethodCheck(this, Watch);
    if (this.ignore(path)) {
      return;
    }
    
    // log 'onChange', change, path, dir
    if (/\d\d\d\d\d\d\d\d?\d?$/.test(slash.ext(path))) {
      return;
    }
    path = slash.join(dir, path);
    // log 'onChange---', path
    if (this.file && this.file !== path) {
      return;
    }
    return this.emit('change', {
      dir: dir,
      path: path,
      change: change,
      watch: this
    });
  }

};

module.exports = Watch;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid2F0Y2guanMiLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiLi4vY29mZmVlL3dhdGNoLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUFBLElBQUEsS0FBQSxFQUFBLENBQUEsRUFBQSxLQUFBLEVBQUEsRUFBQSxFQUFBLEdBQUEsRUFBQSxLQUFBLEVBQUEsT0FBQTtFQUFBOztBQVFBLENBQUEsQ0FBRSxLQUFGLEVBQVMsR0FBVCxFQUFjLEVBQWQsRUFBa0IsQ0FBbEIsQ0FBQSxHQUF3QixPQUFBLENBQVEsT0FBUixDQUF4Qjs7QUFFQSxLQUFBLEdBQVUsT0FBQSxDQUFRLFFBQVI7O0FBQ1YsT0FBQSxHQUFVLE9BQUEsQ0FBUSxTQUFSOztBQUVKLFFBQU4sTUFBQSxNQUFBLFFBQW9CLE1BQXBCO0VBRUksV0FBYSxDQUFDLElBQUQsRUFBTyxHQUFQLENBQUE7O1FBd0ViLENBQUEsZUFBQSxDQUFBO0lBcEVJLElBQUMsQ0FBQSxHQUFELEdBQU8sS0FBSyxDQUFDLE9BQU4sQ0FBYyxJQUFkO0lBQ1AsSUFBQyxDQUFBLEdBQUQsaUJBQU8sTUFBTSxDQUFBO0lBRWIsSUFBQyxDQUFBLFFBQUQsQ0FBQTtFQVBTOztFQVNMLE9BQVAsS0FBTyxDQUFDLElBQUQsRUFBTyxHQUFQLENBQUE7SUFFSixJQUFHLEtBQUssQ0FBQyxLQUFOLENBQVksSUFBWixDQUFIO2FBQ0ksS0FBSyxDQUFDLEdBQU4sQ0FBVSxJQUFWLEVBQWdCLEdBQWhCLEVBREo7S0FBQSxNQUFBO2FBR0ksS0FBSyxDQUFDLElBQU4sQ0FBVyxJQUFYLEVBQWlCLEdBQWpCLEVBSEo7O0VBRkk7O0VBT0QsT0FBTixJQUFNLENBQUMsSUFBRCxFQUFPLEdBQVAsQ0FBQTtBQUVILFFBQUE7SUFBQSxDQUFBLEdBQUksS0FBSyxDQUFDLEdBQU4sQ0FBVSxLQUFLLENBQUMsR0FBTixDQUFVLElBQVYsQ0FBVixFQUEyQixHQUEzQjtJQUNKLENBQUMsQ0FBQyxJQUFGLEdBQVMsS0FB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QURKOztFQUZJOztFQVFSLFFBQVUsQ0FBQyxNQUFELEVBQVMsSUFBVCxFQUFlLE1BQUksSUFBQyxDQUFBLEdBQXBCLENBQUE7MkJBMUVSO0lBNEVFLElBQVUsSUFBQyxDQUFBLE1BQUQsQ0FBUSxJQUFSLENBQVY7QUFBQSxhQUFBO0tBQUE7OztJQUdBLElBQUcsdUJBQXVCLENBQUMsSUFBeEIsQ0FBNkIsS0FBSyxDQUFDLEdBQU4sQ0FBVSxJQUFWLENBQTdCLENBQUg7QUFDSSxhQURKOztJQUdBLElBQUEsR0FBTyxLQUFLLENBQUMsSUFBTixDQUFXLEdBQVgsRUFBZ0IsSUFBaEIsRUFOUDs7SUFRQSxJQUFHLElBQUMsQ0FBQSxJQUFELElBQVUsSUFBQyxDQUFBLElBQUQsS0FBUyxJQUF0QjtBQUNJLGFBREo7O1dBR0EsSUFBQyxDQUFBLElBQUQsQ0FBTSxRQUFOLEVBQWdCO01BQUEsR0FBQSxFQUFJLEdBQUo7TUFBUyxJQUFBLEVBQUssSUFBZDtNQUFvQixNQUFBLEVBQU8sTUFBM0I7TUFBbUMsS0FBQSxFQUFNO0lBQXpDLENBQWhCO0VBYk07O0FBMUVkOztBQXlGQSxNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIiMjI1xuMDAwICAgMDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwMCAgIDAwMDAwMDAgIDAwMCAgIDAwMFxuMDAwIDAgMDAwICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgICAgIDAwMCAgIDAwMFxuMDAwMDAwMDAwICAwMDAwMDAwMDAgICAgIDAwMCAgICAgMDAwICAgICAgIDAwMDAwMDAwMFxuMDAwICAgMDAwICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgICAgIDAwMCAgIDAwMFxuMDAgICAgIDAwICAwMDAgICAwMDAgICAgIDAwMCAgICAgIDAwMDAwMDAgIDAwMCAgIDAwMFxuIyMjXG5cbnsgc2xhc2gsIGxvZywgZnMsIF8gfSA9IHJlcXVpcmUgJy4va3hrJ1xuXG5ldmVudCAgID0gcmVxdWlyZSAnZXZlbnRzJ1xud2Fsa2RpciA9IHJlcXVpcmUgJ3dhbGtkaXInXG5cbmNsYXNzIFdhdGNoIGV4dGVuZHMgZXZlbnRcblxuICAgIGNvbnN0cnVjdG9yOiAocGF0aCwgb3B0KSAtPlxuICAgICAgICBcbiAgICAgICAgc3VwZXIoKVxuICAgICAgICBcbiAgICAgICAgQGRpciA9IHNsYXNoLnJlc29sdmUgcGF0aFxuICAgICAgICBAb3B0ID0gb3B0ID8ge31cbiAgICAgICAgXG4gICAgICAgIEB3YXRjaERpcigpXG4gICAgICAgXG4gICAgQHdhdGNoOiAocGF0aCwgb3B0KSAtPlxuICAgIFxuICAgICAgICBpZiBzbGFzaC5pc0RpciBwYXRoXG4gICAgICAgICAgICBXYXRjaC5kaXIgcGF0aCwgb3B0XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIFdhdGNoLmZpbGUgcGF0aCwgb3B0XG4gICAgXG4gICAgQGZpbGU6IChwYXRoLCBvcHQpIC0+XG4gICAgICAgICAgICBcbiAgICAgICAgdyA9IFdhdGNoLmRpciBzbGFzaC5kaXIocGF0aCksIG9wdFxuICAgICAgICB3LmZpbGUgPSBzbGFzaC5yZXNvbHZlIHBhdGhcbiAgICAgICAgd1xuICAgICAgICBcbiAgICBAZGlyOiAocGF0aCwgb3B0KSAtPlxuICAgICAgICBcbiAgICAgICAgbmV3IFdhdGNoIHBhdGgsIG9wdFxuXG4gICAgY2xvc2U6IC0+XG4gICAgICAgIFxuICAgICAgICBAd2F0Y2guY2xvc2UoKVxuICAgICAgICBkZWxldGUgQHdhdGNoXG4gICAgICAgIFxuICAgICAgICBpZiBAb3B0LnJlY3Vyc2l2ZVxuICAgICAgICAgICAgZm9yIHdhdGNoIGluIEB3YXRjaGVycyBcbiAgICAgICAgICAgICAgICB3YXRjaC5jbG9zZSgpXG4gICAgICAgICAgICBkZWxldGUgQHdhdGNoZXJzXG4gICAgICAgIFxuICAgIHdhdGNoRGlyOiAtPlxuICAgICAgICBcbiAgICAgICAgQHdhdGNoID0gZnMud2F0Y2ggQGRpclxuICAgICAgICBAd2F0Y2gub24gJ2Vycm9yJywgKGVycikgLT4gbG9nIFwiZnMud2F0Y2ggZGlyOicje0BkaXJ9JyBlcnJvcjogI3tlcnIuc3RhY2t9XCJcbiAgICAgICAgQHdhdGNoLm9uICdjaGFuZ2UnLCBAb25DaGFuZ2VcbiAgICAgICAgXG4gICAgICAgIGlmIEBvcHQucmVjdXJzaXZlXG4gICAgICAgICAgICAjIGxvZyAnaWdub3JlJywgQG9wdC5pZ25vcmVcbiAgICAgICAgICAgIEB3YXRjaGVycyA9IFtdXG4gICAgICAgICAgICBAd2Fsa2VyID0gd2Fsa2RpciBAZGlyXG4gICAgICAgICAgICBvblBhdGggPSAoaWdub3JlKSAtPiAocGF0aCkgLT4gXG4gICAgICAgICAgICAgICAgZm9yIHJlZ2V4IGluIGlnbm9yZVxuICAgICAgICAgICAgICAgICAgICBpZiBuZXcgUmVnRXhwKHJlZ2V4KS50ZXN0IHBhdGhcbiAgICAgICAgICAgICAgICAgICAgICAgICMgbG9nIFwiaWdub3JlICN7cmVnZXh9ICN7cGF0aH1cIlxuICAgICAgICAgICAgICAgICAgICAgICAgQGlnbm9yZSBwYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgQG9wdC5pZ25vcmVcbiAgICAgICAgICAgICAgICBAd2Fsa2VyLm9uICdwYXRoJywgb25QYXRoIEBvcHQuaWdub3JlXG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBAd2Fsa2VyLm9uICdkaXJlY3RvcnknLCAocGF0aCkgPT5cbiAgICAgICAgICAgICAgICByZXR1cm4gaWYgQGlnbm9yZSBwYXRoXG4gICAgICAgICAgICAgICAgIyBsb2cgXCJ3YXRjaCAje3BhdGh9XCJcbiAgICAgICAgICAgICAgICB3YXRjaCA9IGZzLndhdGNoIHBhdGhcbiAgICAgICAgICAgICAgICBAd2F0Y2hlcnMucHVzaCB3YXRjaFxuICAgICAgICAgICAgICAgIGNoYW5nZSA9IChkaXIpID0+IChjaGcsIHB0aCkgPT4gQG9uQ2hhbmdlIGNoZywgcHRoLCBkaXJcbiAgICAgICAgICAgICAgICB3YXRjaC5vbiAnY2hhbmdlJywgY2hhbmdlIHBhdGhcblxuICAgIGlnbm9yZTogKHBhdGgpIC0+XG4gICAgICAgIFxuICAgICAgICBpZiBAb3B0Lmlnbm9yZVxuICAgICAgICAgICAgZm9yIHJlZ2V4IGluIEBvcHQuaWdub3JlXG4gICAgICAgICAgICAgICAgaWYgbmV3IFJlZ0V4cChyZWdleCkudGVzdCBwYXRoXG4gICAgICAgICAgICAgICAgICAgICMgbG9nIFwiaWdub3JlISAje3JlZ2V4fSAje3BhdGh9XCJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgICAgICAgICBcbiAgICBvbkNoYW5nZTogKGNoYW5nZSwgcGF0aCwgZGlyPUBkaXIpID0+XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gaWYgQGlnbm9yZSBwYXRoXG4gICAgICAgIFxuICAgICAgICAjIGxvZyAnb25DaGFuZ2UnLCBjaGFuZ2UsIHBhdGgsIGRpclxuICAgICAgICBpZiAvXFxkXFxkXFxkXFxkXFxkXFxkXFxkXFxkP1xcZD8kLy50ZXN0IHNsYXNoLmV4dCBwYXRoXG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgICBwYXRoID0gc2xhc2guam9pbiBkaXIsIHBhdGhcbiAgICAgICAgIyBsb2cgJ29uQ2hhbmdlLS0tJywgcGF0aFxuICAgICAgICBpZiBAZmlsZSBhbmQgQGZpbGUgIT0gcGF0aFxuICAgICAgICAgICAgcmV0dXJuXG4gICAgICAgICAgICBcbiAgICAgICAgQGVtaXQgJ2NoYW5nZScsIGRpcjpkaXIsIHBhdGg6cGF0aCwgY2hhbmdlOmNoYW5nZSwgd2F0Y2g6QFxuICAgICAgICBcbm1vZHVsZS5leHBvcnRzID0gV2F0Y2hcbiJdfQ==
//# sourceURL=../coffee/watch.coffee