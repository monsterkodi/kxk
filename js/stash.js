(function() {
  /*
   0000000  000000000   0000000    0000000  000   000  
  000          000     000   000  000       000   000  
  0000000      000     000000000  0000000   000000000  
       000     000     000   000       000  000   000  
  0000000      000     000   000  0000000   000   000  
  */
  var Stash, _, atomic, error, fs, log, noon, sds, slash;

  ({noon, atomic, slash, fs, sds, log, error, _} = require('./kxk'));

  // simple key value store with delayed saving to userData folder
  // does not sync between processes
  Stash = class Stash {
    constructor(name, opt) {
      var app, electron, ref, ref1, ref2, ref3;
      
      //  0000000   0000000   000   000  00000000
      // 000       000   000  000   000  000     
      // 0000000   000000000   000 000   0000000 
      //      000  000   000     000     000     
      // 0000000   000   000      0      00000000
      this.save = this.save.bind(this);
      this.name = name;
      if (!this.name) {
        return error('stash.constructor -- no name?');
      }
      electron = require('electron');
      app = (ref = electron.app) != null ? ref : electron.remote.app;
      this.sep = (ref1 = opt != null ? opt.separator : void 0) != null ? ref1 : ':';
      this.timer = null;
      this.file = slash.path((ref2 = opt != null ? opt.file : void 0) != null ? ref2 : `${app.getPath('userData')}/${this.name}.noon`);
      this.timeout = (ref3 = opt != null ? opt.timeout : void 0) != null ? ref3 : 4000;
      this.changes = [];
      fs.ensureDirSync(slash.dirname(this.file));
      this.data = this.load();
      if ((opt != null ? opt.defaults : void 0) != null) {
        this.data = _.defaults(this.data, opt.defaults);
      }
    }

    keypath(key) {
      return key.split(this.sep);
    }

    
    //  0000000   00000000  000000000
    // 000        000          000   
    // 000  0000  0000000      000   
    // 000   000  000          000   
    //  0000000   00000000     000   
    get(key, value) {
      if ((key != null ? key.split : void 0) == null) {
        error('stash.get -- invalid key', key);
      }
      if ((key != null ? key.split : void 0) == null) {
        return value;
      }
      return sds.get(this.data, this.keypath(key), value);
    }

    
    //  0000000  00000000  000000000  
    // 000       000          000     
    // 0000000   0000000      000     
    //      000  000          000     
    // 0000000   00000000     000     
    set(key, value) {
      if ((key != null ? key.split : void 0) == null) {
        return error('stash.set -- invalid key', key);
      }
      sds.set(this.data, this.keypath(key), value);
      if (this.timer) {
        clearTimeout(this.timer);
      }
      return this.timer = setTimeout(this.save, this.timeout);
    }

    del(key) {
      return this.set(key);
    }

    clear() {
      this.data = {};
      clearTimeout(this.timer);
      this.timer = null;
      return fs.removeSync(this.file);
    }

    
    // 000       0000000    0000000   0000000    
    // 000      000   000  000   000  000   000  
    // 000      000   000  000000000  000   000  
    // 000      000   000  000   000  000   000  
    // 0000000   0000000   000   000  0000000    
    load() {
      var err;
      try {
        return noon.load(this.file);
      } catch (error1) {
        err = error1;
        return {};
      }
    }

    save() {
      var err;
      if (!this.file) {
        return;
      }
      clearTimeout(this.timer);
      this.timer = null;
      try {
        log('save stash', this.file);
        return atomic.sync(this.file, noon.stringify(this.data, {
          indent: 2,
          maxalign: 8
        }));
      } catch (error1) {
        err = error1;
        return error(`stash.save -- can't save to '${this.file}': ${err}`);
      }
    }

  };

  module.exports = Stash;

}).call(this);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3Rhc2guanMiLCJzb3VyY2VSb290IjoiLiIsInNvdXJjZXMiOlsiLi4vY29mZmVlL3N0YXNoLmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtFQUFBOzs7Ozs7O0FBQUEsTUFBQSxLQUFBLEVBQUEsQ0FBQSxFQUFBLE1BQUEsRUFBQSxLQUFBLEVBQUEsRUFBQSxFQUFBLEdBQUEsRUFBQSxJQUFBLEVBQUEsR0FBQSxFQUFBOztFQVFBLENBQUEsQ0FBRSxJQUFGLEVBQVEsTUFBUixFQUFnQixLQUFoQixFQUF1QixFQUF2QixFQUEyQixHQUEzQixFQUFnQyxHQUFoQyxFQUFxQyxLQUFyQyxFQUE0QyxDQUE1QyxDQUFBLEdBQWtELE9BQUEsQ0FBUSxPQUFSLENBQWxELEVBUkE7Ozs7RUFhTSxRQUFOLE1BQUEsTUFBQTtJQUVJLFdBQWEsS0FBQSxFQUFRLEdBQVIsQ0FBQTtBQUVULFVBQUEsR0FBQSxFQUFBLFFBQUEsRUFBQSxHQUFBLEVBQUEsSUFBQSxFQUFBLElBQUEsRUFBQSxJQUFBOzs7Ozs7O1VBcUVKLENBQUEsV0FBQSxDQUFBO01BdkVjLElBQUMsQ0FBQTtNQUVYLElBQWdELENBQUksSUFBQyxDQUFBLElBQXJEO0FBQUEsZUFBTyxLQUFBLENBQU0sK0JBQU4sRUFBUDs7TUFFQSxRQUFBLEdBQVcsT0FBQSxDQUFRLFVBQVI7TUFDWCxHQUFBLHdDQUFzQixRQUFRLENBQUMsTUFBTSxDQUFDO01BRXRDLElBQUMsQ0FBQSxHQUFELGtFQUF3QjtNQUN4QixJQUFDLENBQUEsS0FBRCxHQUFXO01BQ1gsSUFBQyxDQUFBLElBQUQsR0FBVyxLQUFLLENBQUMsSUFBTiwyREFBdUIsQ0FBQSxDQUFBLENBQUcsR0FBRyxDQUFDLE9BQUosQ0FBWSxVQUFaLENBQUgsQ0FBMkIsQ0FBM0IsQ0FBQSxDQUE4QixJQUFDLENBQUEsSUFBL0IsQ0FBb0MsS0FBcEMsQ0FBdkI7TUFDWCxJQUFDLENBQUEsT0FBRCxnRUFBMEI7TUFDMUIsSUFBQyxDQUFBLE9BQUQsR0FBVztNQUVYLEVBQUUsQ0FBQyxhQUFILENBQWlCLEtBQUssQ0FBQyxPQUFOLENBQWMsSUFBQyxDQUFBLElBQWYsQ0FBakI7TUFDQSxJQUFDLENBQUEsSUFBRCxHQUFRLElBQUMsQ0FBQSxJQUFELENBQUE7TUFDUixJQUEwQyw2Q0FBMUM7UUFBQSxJQUFDLENBQUEsSUFBRCxHQUFRLENBQUMsQ0FBQyxRQUFGLENBQVcsSUFBQyxDQUFBLElBQVosRUFBa0IsR0FBRyxDQUFDLFFBQXRCLEVBQVI7O0lBZlM7O0lBaUJiLE9BQVMsQ0FBQyxHQUFELENBQUE7YUFBUyxHQUFHLENBQUMsS0FBSixDQUFVLElBQUMsQ0FBQSxHQUFYO0lBQVQsQ0FqQlQ7Ozs7Ozs7O0lBeUJBLEdBQUssQ0FBQyxHQUFELEVBQU0sS0FBTixDQUFBO01BQ0QsSUFBNkMsMENBQTdDO1FBQUEsS0FBQSxDQUFNLDBCQUFOLEVBQWtDLEdBQWxDLEVBQUE7O01BQ0EsSUFBb0IsMENBQXBCO0FBQUEsZUFBTyxNQUFQOzthQUNBLEdBQUcsQ0FBQyxHQUFKLENBQVEsSUFBQyxDQUFBLElBQVQsRUFBZSxJQUFDLENBQUEsT0FBRCxDQUFTLEdBQVQsQ0FBZixFQUE4QixLQUE5QjtJQUhDLENBekJMOzs7Ozs7OztJQW9DQSxHQUFLLENBQUMsR0FBRCxFQUFNLEtBQU4sQ0FBQTtNQUVELElBQW9ELDBDQUFwRDtBQUFBLGVBQU8sS0FBQSxDQUFNLDBCQUFOLEVBQWtDLEdBQWxDLEVBQVA7O01BQ0EsR0FBRyxDQUFDLEdBQUosQ0FBUSxJQUFDLENBQUEsSUFBVCxFQUFlLElBQUMsQ0FBQSxPQUFELENBQVMsR0FBVCxDQUFmLEVBQThCLEtBQTlCO01BRUEsSUFBdUIsSUFBQyxDQUFBLEtBQXhCO1FBQUEsWUFBQSxDQUFhLElBQUMsQ0FBQSxLQUFkLEVBQUE7O2FBQ0EsSUFBQyxDQUFBLEtBQUQsR0FBUyxVQUFBLENBQVcsSUFBQyxDQUFBLElBQVosRUFBa0IsSUFBQyxDQUFBLE9BQW5CO0lBTlI7O0lBUUwsR0FBSyxDQUFDLEdBQUQsQ0FBQTthQUFTLElBQUMsQ0FBQSxHQUFELENBQUssR0FBTDtJQUFUOztJQUVMLEtBQU8sQ0FBQSxDQUFBO01BRUgsSUFBQyxDQUFBLElBQUQsR0FBUSxDQUFBO01BQ1IsWUFBQSxDQUFhLElBQUMsQ0FBQSxLQUFkO01BQ0EsSUFBQyxDQUFBLEtBQUQsR0FBUzthQUNULEVBQUUsQ0FBQyxVQUFILENBQWMsSUFBQyxDQUFBLElBQWY7SUFMRyxDQTlDUDs7Ozs7Ozs7SUEyREEsSUFBTSxDQUFBLENBQUE7QUFDRixVQUFBO0FBQUE7ZUFDSSxJQUFJLENBQUMsSUFBTCxDQUFVLElBQUMsQ0FBQSxJQUFYLEVBREo7T0FBQSxjQUFBO1FBRU07ZUFDRixDQUFBLEVBSEo7O0lBREU7O0lBWU4sSUFBTSxDQUFBLENBQUE7QUFFRixVQUFBO01BQUEsSUFBVSxDQUFJLElBQUMsQ0FBQSxJQUFmO0FBQUEsZUFBQTs7TUFFQSxZQUFBLENBQWEsSUFBQyxDQUFBLEtBQWQ7TUFDQSxJQUFDLENBQUEsS0FBRCxHQUFTO0FBQ1Q7UUFDSSxHQUFBLENBQUksWUFBSixFQUFrQixJQUFDLENBQUEsSUFBbkI7ZUFDQSxNQUFNLENBQUMsSUFBUCxDQUFZLElBQUMsQ0FBQSxJQUFiLEVBQW1CLElBQUksQ0FBQyxTQUFMLENBQWUsSUFBQyxDQUFBLElBQWhCLEVBQXNCO1VBQUUsTUFBQSxFQUFRLENBQVY7VUFBYSxRQUFBLEVBQVU7UUFBdkIsQ0FBdEIsQ0FBbkIsRUFGSjtPQUFBLGNBQUE7UUFHTTtlQUNGLEtBQUEsQ0FBTSxDQUFBLDZCQUFBLENBQUEsQ0FBZ0MsSUFBQyxDQUFBLElBQWpDLENBQXNDLEdBQXRDLENBQUEsQ0FBMkMsR0FBM0MsQ0FBQSxDQUFOLEVBSko7O0lBTkU7O0VBekVWOztFQXFGQSxNQUFNLENBQUMsT0FBUCxHQUFpQjtBQWxHakIiLCJzb3VyY2VzQ29udGVudCI6WyIjIyNcbiAwMDAwMDAwICAwMDAwMDAwMDAgICAwMDAwMDAwICAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgXG4wMDAgICAgICAgICAgMDAwICAgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIFxuMDAwMDAwMCAgICAgIDAwMCAgICAgMDAwMDAwMDAwICAwMDAwMDAwICAgMDAwMDAwMDAwICBcbiAgICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgICAgICAwMDAgIDAwMCAgIDAwMCAgXG4wMDAwMDAwICAgICAgMDAwICAgICAwMDAgICAwMDAgIDAwMDAwMDAgICAwMDAgICAwMDAgIFxuIyMjXG5cbnsgbm9vbiwgYXRvbWljLCBzbGFzaCwgZnMsIHNkcywgbG9nLCBlcnJvciwgXyB9ID0gcmVxdWlyZSAnLi9reGsnXG5cbiMgc2ltcGxlIGtleSB2YWx1ZSBzdG9yZSB3aXRoIGRlbGF5ZWQgc2F2aW5nIHRvIHVzZXJEYXRhIGZvbGRlclxuIyBkb2VzIG5vdCBzeW5jIGJldHdlZW4gcHJvY2Vzc2VzXG4gXG5jbGFzcyBTdGFzaFxuICAgIFxuICAgIGNvbnN0cnVjdG9yOiAoQG5hbWUsIG9wdCkgLT5cblxuICAgICAgICByZXR1cm4gZXJyb3IgJ3N0YXNoLmNvbnN0cnVjdG9yIC0tIG5vIG5hbWU/JyBpZiBub3QgQG5hbWVcbiAgICAgICAgXG4gICAgICAgIGVsZWN0cm9uID0gcmVxdWlyZSAnZWxlY3Ryb24nXG4gICAgICAgIGFwcCAgPSBlbGVjdHJvbi5hcHAgPyBlbGVjdHJvbi5yZW1vdGUuYXBwXG5cbiAgICAgICAgQHNlcCA9IG9wdD8uc2VwYXJhdG9yID8gJzonXG4gICAgICAgIEB0aW1lciAgID0gbnVsbFxuICAgICAgICBAZmlsZSAgICA9IHNsYXNoLnBhdGggb3B0Py5maWxlID8gXCIje2FwcC5nZXRQYXRoKCd1c2VyRGF0YScpfS8je0BuYW1lfS5ub29uXCJcbiAgICAgICAgQHRpbWVvdXQgPSBvcHQ/LnRpbWVvdXQgPyA0MDAwXG4gICAgICAgIEBjaGFuZ2VzID0gW11cbiAgICAgICAgXG4gICAgICAgIGZzLmVuc3VyZURpclN5bmMgc2xhc2guZGlybmFtZSBAZmlsZVxuICAgICAgICBAZGF0YSA9IEBsb2FkKClcbiAgICAgICAgQGRhdGEgPSBfLmRlZmF1bHRzIEBkYXRhLCBvcHQuZGVmYXVsdHMgaWYgb3B0Py5kZWZhdWx0cz9cblxuICAgIGtleXBhdGg6IChrZXkpIC0+IGtleS5zcGxpdCBAc2VwXG4gICAgXG4gICAgIyAgMDAwMDAwMCAgIDAwMDAwMDAwICAwMDAwMDAwMDBcbiAgICAjIDAwMCAgICAgICAgMDAwICAgICAgICAgIDAwMCAgIFxuICAgICMgMDAwICAwMDAwICAwMDAwMDAwICAgICAgMDAwICAgXG4gICAgIyAwMDAgICAwMDAgIDAwMCAgICAgICAgICAwMDAgICBcbiAgICAjICAwMDAwMDAwICAgMDAwMDAwMDAgICAgIDAwMCAgIFxuICAgICAgICBcbiAgICBnZXQ6IChrZXksIHZhbHVlKSAtPlxuICAgICAgICBlcnJvciAnc3Rhc2guZ2V0IC0tIGludmFsaWQga2V5Jywga2V5IGlmIG5vdCBrZXk/LnNwbGl0P1xuICAgICAgICByZXR1cm4gdmFsdWUgaWYgbm90IGtleT8uc3BsaXQ/XG4gICAgICAgIHNkcy5nZXQgQGRhdGEsIEBrZXlwYXRoKGtleSksIHZhbHVlXG4gICAgICAgICBcbiAgICAjICAwMDAwMDAwICAwMDAwMDAwMCAgMDAwMDAwMDAwICBcbiAgICAjIDAwMCAgICAgICAwMDAgICAgICAgICAgMDAwICAgICBcbiAgICAjIDAwMDAwMDAgICAwMDAwMDAwICAgICAgMDAwICAgICBcbiAgICAjICAgICAgMDAwICAwMDAgICAgICAgICAgMDAwICAgICBcbiAgICAjIDAwMDAwMDAgICAwMDAwMDAwMCAgICAgMDAwICAgICBcbiAgICBcbiAgICBzZXQ6IChrZXksIHZhbHVlKSAtPlxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGVycm9yICdzdGFzaC5zZXQgLS0gaW52YWxpZCBrZXknLCBrZXkgaWYgbm90IGtleT8uc3BsaXQ/XG4gICAgICAgIHNkcy5zZXQgQGRhdGEsIEBrZXlwYXRoKGtleSksIHZhbHVlXG4gICAgICAgIFxuICAgICAgICBjbGVhclRpbWVvdXQgQHRpbWVyIGlmIEB0aW1lclxuICAgICAgICBAdGltZXIgPSBzZXRUaW1lb3V0IEBzYXZlLCBAdGltZW91dFxuICAgICAgICAgICAgICAgICAgICBcbiAgICBkZWw6IChrZXkpIC0+IEBzZXQga2V5XG4gICAgXG4gICAgY2xlYXI6IC0+XG4gICAgICAgIFxuICAgICAgICBAZGF0YSA9IHt9XG4gICAgICAgIGNsZWFyVGltZW91dCBAdGltZXJcbiAgICAgICAgQHRpbWVyID0gbnVsbFxuICAgICAgICBmcy5yZW1vdmVTeW5jIEBmaWxlXG4gICAgICAgIFxuICAgICMgMDAwICAgICAgIDAwMDAwMDAgICAgMDAwMDAwMCAgIDAwMDAwMDAgICAgXG4gICAgIyAwMDAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICBcbiAgICAjIDAwMCAgICAgIDAwMCAgIDAwMCAgMDAwMDAwMDAwICAwMDAgICAwMDAgIFxuICAgICMgMDAwICAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgXG4gICAgIyAwMDAwMDAwICAgMDAwMDAwMCAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgICBcbiAgICBcbiAgICBsb2FkOiAtPlxuICAgICAgICB0cnlcbiAgICAgICAgICAgIG5vb24ubG9hZCBAZmlsZVxuICAgICAgICBjYXRjaCBlcnJcbiAgICAgICAgICAgIHt9XG4gICAgICAgIFxuICAgICMgIDAwMDAwMDAgICAwMDAwMDAwICAgMDAwICAgMDAwICAwMDAwMDAwMFxuICAgICMgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgIFxuICAgICMgMDAwMDAwMCAgIDAwMDAwMDAwMCAgIDAwMCAwMDAgICAwMDAwMDAwIFxuICAgICMgICAgICAwMDAgIDAwMCAgIDAwMCAgICAgMDAwICAgICAwMDAgICAgIFxuICAgICMgMDAwMDAwMCAgIDAwMCAgIDAwMCAgICAgIDAgICAgICAwMDAwMDAwMFxuXG4gICAgc2F2ZTogPT5cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBpZiBub3QgQGZpbGVcbiAgICAgICAgXG4gICAgICAgIGNsZWFyVGltZW91dCBAdGltZXJcbiAgICAgICAgQHRpbWVyID0gbnVsbFxuICAgICAgICB0cnlcbiAgICAgICAgICAgIGxvZyAnc2F2ZSBzdGFzaCcsIEBmaWxlXG4gICAgICAgICAgICBhdG9taWMuc3luYyBAZmlsZSwgbm9vbi5zdHJpbmdpZnkgQGRhdGEsIHsgaW5kZW50OiAyLCBtYXhhbGlnbjogOCB9XG4gICAgICAgIGNhdGNoIGVyclxuICAgICAgICAgICAgZXJyb3IgXCJzdGFzaC5zYXZlIC0tIGNhbid0IHNhdmUgdG8gJyN7QGZpbGV9JzogI3tlcnJ9XCJcbiAgICAgICAgXG5tb2R1bGUuZXhwb3J0cyA9IFN0YXNoXG4iXX0=
//# sourceURL=../coffee/stash.coffee